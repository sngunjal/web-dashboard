<script type="module">
    import { Buffer } from "https://cdn.jsdelivr.net/npm/buffer@6.0.3/+esm";

    const MAPBOX_API_KEY = "pk.eyJ1Ijoic25ndW5qYWwiLCJhIjoiY200bzB6ZjZrMGRjNjJtcXMzNXl4YTBkNCJ9.FdaDmXJ0r-Ie7jaln3h86Q";

    const bounds = L.latLngBounds(
        [19.2100, 72.8528],
        [19.2400, 72.8870]
    );

    const map = L.map('map', {
        maxBounds: bounds,
        maxBoundsViscosity: 1.0
    }).setView([19.22144, 72.8680], 13.75);

    L.tileLayer(`https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/{z}/{x}/{y}?access_token=${MAPBOX_API_KEY}`, {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery &copy; <a href="https://www.mapbox.com/">Mapbox</a>',
        tileSize: 512,
        zoomOffset: -1
    }).addTo(map);

    let iconSize = [20, 20];

    const bus1Icon = L.icon({
        iconUrl: './BusblueIcon.png',
        iconSize: iconSize,
        iconAnchor: [10, 20],
        popupAnchor: [0, -40]
    });

    const bus2Icon = L.icon({
        iconUrl: './BusgreenIcon.png',
        iconSize: iconSize,
        iconAnchor: [10, 20],
        popupAnchor: [0, -40]
    });

    map.on('zoom', function () {
        const zoom = map.getZoom();
        const newSize = zoom > 14 ? [30, 30] : [20, 20];

        bus1Icon.options.iconSize = newSize;
        bus2Icon.options.iconSize = newSize;

        Object.values(markers).forEach(marker => {
            marker.setIcon(L.icon({
                iconUrl: marker.options.icon.options.iconUrl,
                iconSize: newSize,
                iconAnchor: [10, 20],
                popupAnchor: [0, -40]
            }));
        });
    });

    const markers = {};

    function updateMarker(deviceId, lat, lon, icon) {
        if (markers[deviceId]) {
            markers[deviceId].setLatLng([lat, lon]);
        } else {
            const marker = L.marker([lat, lon], { icon: icon })
                .addTo(map)
                .bindPopup(`<b>Call:</b> <a href="tel:${deviceId}">${deviceId}</a>`);
            markers[deviceId] = marker;
        }
    }

    async function fetchTraccarPositions() {
        const auth = Buffer.from("admin:admin").toString("base64"); // Replace with actual Traccar login if changed
        const response = await fetch("http://3.109.42.82:8082/api/positions", {
            headers: {
                "Authorization": `Basic ${auth}`
            }
        });

        if (!response.ok) {
            console.error("❌ Failed to fetch from Traccar:", response.statusText);
            return;
        }

        const data = await response.json();
        data.forEach(pos => {
            if (pos.deviceId === 1) {
                updateMarker("9136998836", pos.latitude, pos.longitude, bus1Icon);
            } else if (pos.deviceId === 2) {
                updateMarker("9136828236", pos.latitude, pos.longitude, bus2Icon);
            }
        });
    }

    setInterval(fetchTraccarPositions, 10000);
    fetchTraccarPositions();

    const locations = [
        { name: "Colony", lat: 19.214432, lon: 72.878878 },
        { name: "SGNP Gate", lat: 19.2314, lon: 72.8636 },
        { name: "Station", lat: 19.2314, lon: 72.859 },
        { name: "St John School", lat: 19.2177, lon: 72.8703 },
        { name: "Ryan School", lat: 19.2131, lon: 72.8622 }
    ];

    function createFlagMarker(location) {
        const icon = L.divIcon({
            className: '',
            html: `<div class="flag-icon">
                    <img src="https://cdn.shopify.com/s/files/1/1061/1924/files/Red_Flag_Emoji.png?9898922749706957214" alt="flag">
                    <div class="tooltip">${location.name}</div>
                </div>`,
            iconSize: null,
            iconAnchor: [12, 25],
        });

        L.marker([location.lat, location.lon], { icon: icon }).addTo(map);
    }

    locations.forEach(createFlagMarker);

    map.on('zoom', function () {
        const zoom = map.getZoom();
        const newSize = zoom > 14 ? '35px' : '25px';
        document.querySelectorAll('.flag-icon img').forEach(img => {
            img.style.height = newSize;
        });
    });
</script>









